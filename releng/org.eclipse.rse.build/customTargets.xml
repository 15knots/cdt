<project name="Build specific targets and properties" default="noDefault">

	<!-- ===================================================================== -->
	<!-- Run a given ${target} on all elements being built -->
	<!-- Add on <ant> task for each top level element being built. -->
	<!-- ===================================================================== -->
	<target name="allElements">
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.core" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.local" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.ftp" />
		</ant>
		<ant antfile="${genericTargets}" target="${target}">
			<property name="type" value="feature" />
			<property name="id" value="org.eclipse.rse.dstore" />
		</ant>
	</target>

	<!-- ===================================================================== -->
	<!-- Targets to assemble the built elements for particular configurations  -->
	<!-- These generally call the generated assemble scripts (named in         -->
	<!-- ${assembleScriptName}) but may also add pre and post processing       -->
	<!-- Add one target for each root element and each configuration           -->
	<!-- ===================================================================== -->

	<target name="assemble.org.eclipse.rse.core">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
		<antcall target="assemble.source.feature"/>
	</target>

	<target name="assemble.org.eclipse.rse.local">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.ftp">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>

	<target name="assemble.org.eclipse.rse.dstore">
		<ant antfile="${assembleScriptName}" dir="${buildDirectory}"/>
	</target>
	
	<target name="assemble.source.feature">
		<echo message="buildDirectory = ${buildDirectory}"/>
		<echo message="id = ${id}"/>
		<echo message="buildLabel = ${buildLabel}"/>
		<echo message="buildId = ${buildId}"/>
		<echo message="archivePrefix = ${archivePrefix}"/>
	</target>

	<target name="serverruntime">

		<property name="working" value="${packageDirectory}/rseserver"/>
		<mkdir dir="${working}" />
		<mkdir dir="${working}/jars" />

		<copy todir="${working}">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore/serverruntime" includes="**" />
		</copy>

		<copy todir="${working}/jars">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.core" includes="dstore_core.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.extra" includes="dstore_extra_server.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services" includes="clientserver.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore" includes="dstore_miners.jar" />
		</copy>
		
		<antcall target="rseserver-os">
			<param name="os" value="aix"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="unix"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="linux"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os">
			<param name="os" value="windows"/>
			<param name="eol" value="crlf"/>
		</antcall>
		
		<delete dir="${working}" />

	</target>
	
	<target name="rseserver-os">
		<mkdir dir="${working}/collector" />
		<copy todir="${working}/collector">
			<fileset dir="${working}/scripts/${os}" includes="*"/>
		</copy>
		<chmod perm="u+rx" includes="${working}/collector/*"/>
		<copy todir="${working}/collector">
			<fileset dir="${working}/data" includes="*"/>
		</copy>
		<fixcrlf srcdir="${working}/collector" eol="${eol}" eof="asis" includes="*"/>
		<copy todir="${working}/collector">
			<fileset dir="${working}/jars" includes="*"/>
		</copy>
		<tar destfile="${packageDirectory}\rseserver-${os}.tar" basedir="${working}/collector" includes="*"/>
		<zip destfile="${packageDirectory}\rseserver-${os}.zip" basedir="${working}/collector" includes="*"/>
		<delete dir="${working}/collector" />
	</target>
	
	<target name="hideServerStuff">
		<move todir="${buildDirectory}/plugins">
			<fileset dir="${buildDirectory}/plugins" includes="**/*.jar" />
			<fileset dir="${buildDirectory}/plugins" includes="**/*.zip" excludes="**/src.zip"/>
			<globmapper from="*" to="*.hidden"/>
		</move>
	</target>

	<target name="revealServerStuff">
		<move todir="${buildDirectory}/plugins">
			<fileset dir="${buildDirectory}/plugins" includes="**/*.hidden" />
			<globmapper from="*.hidden" to="*"/>
		</move>
	</target>

	<!-- ===================================================================== -->
	<!-- Check out map files from correct repository -->
	<!-- Replace values for cvsRoot, package and mapVersionTag as desired. -->
	<!-- ===================================================================== -->
	<target name="getMapFiles">
		<!-- Notify recipients that build has started.-->
		<!--
		<property name="cvsRoot" value=":pserver:build@dbgaix2:/usr/vatpfcvs" />
		<property name="mapVersionTag" value="HEAD" />
		<cvs cvsRoot="${cvsRoot}"
			package="MenuEditorBuilder"
			dest="${buildDirectory}/maps"
			tag="${mapVersionTag}"
		/>
		-->
		<copy todir="${buildDirectory}/maps">
			<fileset dir="." includes="*.map" />
		</copy>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before setup -->
	<!-- ===================================================================== -->
	<target name="preSetup">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after setup but before starting the build proper -->
	<!-- ===================================================================== -->
	<target name="postSetup">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="preFetch">
		<!-- clean up the old driver -->
		<!--	<delete includeEmptyDirs="true">-->
		<!--
		<fileset dir="${buildDirectory}\plugins" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${buildDirectory}\features" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${builddest}" casesensitive="yes" defaultexcludes="yes">
			<include name="full/eclipse/**" />
			<include name="full/Config/**" />
			<include name="lite/**" />
		</fileset>
		<fileset dir="${head}\eclipse\plugins" casesensitive="yes" defaultexcludes="yes">
			<include name="org.eclipse.*/**" />
		</fileset>
		<fileset dir="${head}\eclipse\features" casesensitive="yes" defaultexcludes="no">
			<include name="org.eclipse.*/**" />
		</fileset>
		-->
		<!--	</delete>-->
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after fetching the build elements -->
	<!-- ===================================================================== -->
	<target name="postFetch">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="preGenerate">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after generating the build scripts. -->
	<!-- ===================================================================== -->
	<target name="postGenerate">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="preProcess">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after running the build.xmls for the elements being built. -->
	<!-- ===================================================================== -->
	<target name="postProcess">
		<antcall target="allElements">
			<param name="target" value="gatherLogs" />
		</antcall>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do before running assemble. -->
	<!-- ===================================================================== -->
	<target name="preAssemble">
		<antcall target="serverruntime" />
		<antcall target="hideServerStuff" />
		<antcall target="allElements">
			<param name="target" value="gatherSources" />
		</antcall>
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after  running assemble. -->
	<!-- ===================================================================== -->
	<target name="postAssemble">
		<antcall target="revealServerStuff" />
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after the build is done. -->
	<!-- ===================================================================== -->
	<target name="postBuild">
		<!--
		<mkdir dir="${packageDirectory}" />

		<property name="packageRuntimeDirectory" location="${packageDirectory}\runtime" />
		<mkdir dir="${packageRuntimeDirectory}" />

		<unzip src="${buildDirectory}\features\org.eclipse.rse.core\org.eclipse.rse.core_1.0.0.bin.dist.zip" dest="${packageRuntimeRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.dstore\org.eclipse.rse.dstore_1.0.0.bin.dist.zip" dest="${packageRuntimeRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.ftp\org.eclipse.rse.ftp_1.0.0.bin.dist.zip" dest="${packageRuntimeRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.local\org.eclipse.rse.local_1.0.0.bin.dist.zip" dest="${packageRuntimeRootDirectory}" />

		<zip destfile="${packageDirectory}\RSE-1.0M1.zip" basedir="${packageRuntimeDirectory}" />

		<property name="packageSDKDirectory" location="${packageDirectory}\sdk" />
		<property name="packageSDKRootDirectory" location="${packageSDKDirectory}\eclipse" />
		<mkdir dir="${packageSDKDirectory}" />
		<mkdir dir="${packageSDKRootDirectory}" />

		<unzip src="${packageDirectory}\RSE-1.0M1.zip" dest="${packageSDKDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.core\org.eclipse.rse.core_1.0.0.src.zip" dest="${packageSDKRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.dstore\org.eclipse.rse.dstore_1.0.0.src.zip" dest="${packageSDKRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.ftp\org.eclipse.rse.ftp_1.0.0.src.zip" dest="${packageSDKRootDirectory}" />
		<unzip src="${buildDirectory}\features\org.eclipse.rse.local\org.eclipse.rse.local_1.0.0.src.zip" dest="${packageSDKRootDirectory}" />

		<zip destfile="${packageDirectory}\RSE-SDK-1.0M1.zip" basedir="${packageSDKDirectory}" />

		<antcall target="serverruntime"/>
		<antcall target="publish"/>
		-->
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to test the build results -->
	<!-- ===================================================================== -->
	<target name="test">
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do to publish the build results -->
	<!-- ===================================================================== -->
	<target name="publish" if="doPublish">
		<mkdir dir="${publishDirectory}" />
		<copy todir="${publishDirectory}">
			<fileset dir="${packageDirectory}" includes="*.zip" />
		</copy>
	</target>

	<!-- ===================================================================== -->
	<!-- Default target                                                        -->
	<!-- ===================================================================== -->
	<target name="noDefault">
		<echo message="You must specify a target when invoking this file" />
	</target>

	<!-- ===================================================================== -->
	<!-- Build the feature in own way                                          -->
	<!-- Somehow the default builder doesn't work                              -->
	<!-- ===================================================================== -->
	<target name="buildFeature">
		<echo message="Building feature ${featureFolder}" />
		<!--
		<ant antfile="${featureFolder}\build.xml" dir="${featureFolder}" target="build.jars" />
		-->
		<ant antfile="${featureFolder}\build.xml" dir="${featureFolder}" target="zip.distribution" />
		<ant antfile="${featureFolder}\build.xml" dir="${featureFolder}" target="zip.sources" />
	</target>

	<!-- ===================================================================== -->
	<!-- Zip the docs                                                          -->
	<!-- ===================================================================== -->
	<target name="zipDoc">
		<zip destfile="${buildDirectory}\plugins\${docPluginID}\doc.zip" filesonly="false" defaultexcludes="true">
			<fileset dir="${buildDirectory}\plugins\${docPluginID}" defaultexcludes="true">
				<include name="**/*.gif" />
				<include name="**/*.html" />
				<include name="**/*.htm" />
				<include name="**/*.GIF" />
				<include name="**/*.HTML" />
				<include name="**/*.HTM" />
				<include name="**/*.css" />
			</fileset>
		</zip>
	</target>

</project>
