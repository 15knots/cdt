<!--
     Copyright (c) 2010 Mentor Graphics Corporation and others.
     All rights reserved. This program and the accompanying materials
     are made available under the terms of the Eclipse Public License v1.0
     which accompanies this distribution, and is available at
     http://www.eclipse.org/legal/epl-v10.html
    
     Contributors:
         Anna Dushistova (Mentor Graphics) - initial API and implementation
 -->
<project default="run" name="Project's .releng buildExtra.xml">

	<target name="init">
	</target>

	<target name="run">
		<!-- TODO: write code that's hooked into o.e.d.commonbuilder.releng's build.xml to do extra configs (eg., for inserting 3rd party libs into plugins) 
		-->
	</target>

	<target name="extraPackaging">
		<!-- USE PDE PACKAGER TO ASSEMBLE THESE ZIPS -->

		<!-- create ALL zip from ${allZip} -->
		<zip destfile="${buildDirectory}/${buildLabel}/TM-ALL-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664" />
		</zip>

		<!-- build RSE SDK: RSE+Orbit, no examples -->
		<zip destfile="${buildDirectory}/${buildLabel}/RSE-SDK-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}"
			            dirmode="775"
			            filemode="664"
			            excludes="**/org.eclipse.*.all*, **/org.eclipse.*.all*/**, **/org.eclipse.*.examples*, **/org.eclipse.*.examples*/**, **/org.eclipse.tm*, **/org.eclipse.tm*/**, **/org.eclipse.rse.wince*, **/org.eclipse.rse.wince*/**, **/org.eclipse.rse.useractions*, **/org.eclipse.rse.useractions*/**, **/org.eclipse.rse.tests*, **/org.eclipse.rse.tests*/**, **/org.eclipse.rse.discovery*, **/org.eclipse.rse.discovery*/** "
			>
				<include name="**/org.eclipse.rse*" />
				<include name="**/org.eclipse.rse*/**" />
				<include name="**/org.eclipse.rse*/**/**" />
				<include name="**/org.apache.common*" />
				<include name="**/org.apache.common*/**" />
				<include name="**/org.apache.common*/**/**" />
			</zipfileset>
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664" id="terminal_required">
				<include name="**/org.eclipse.tm.terminal_*" />
				<include name="**/org.eclipse.tm.terminal_*/**" />
				<include name="**/org.eclipse.tm.terminal_*/**/**" />
			</zipfileset>
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664" id="dstore_required">
				<include name="**/org.eclipse.dstore*" />
				<include name="**/org.eclipse.dstore*/**" />
				<include name="**/org.eclipse.dstore*/**/**" />
			</zipfileset>

			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}"
			            dirmode="775"
			            filemode="664"
			            id="rootfiles"
			            includes="**/eclipse/epl-v10.html, **/eclipse/notice.html"
			/>
		</zip>

		<!-- build RSE runtime: RSE+Orbit, no examples -->
		<zip destfile="${buildDirectory}/${buildLabel}/RSE-runtime-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}"
			            dirmode="775"
			            filemode="664"
			            excludes="**/org.eclipse.*.all*, **/org.eclipse.*.all*/**, **/org.eclipse.*.examples*, **/org.eclipse.*.examples*/**, **/org.eclipse.*.sdk*, **/org.eclipse.*.sdk*/**,**/org.eclipse.*.doc*, **/org.eclipse.*.doc*/*, **/org.eclipse.*.source*, **/org.eclipse.*.source*/**, **/org.apache.*.source*, **/org.apache.*.source*/**, **/*src.zip, **/org.eclipse.tm*, **/org.eclipse.tm*/**, **/org.eclipse.rse.wince*, **/org.eclipse.rse.wince*/**, **/org.eclipse.rse.useractions*, **/org.eclipse.rse.useractions*/**, **/org.eclipse.rse.tests*, **/org.eclipse.rse.tests*/**, **/org.eclipse.rse.discovery*, **/org.eclipse.rse.discovery*/** "
			>
				<include name="**/org.eclipse.rse*" />
				<include name="**/org.eclipse.rse*/**" />
				<include name="**/org.eclipse.rse*/**/**" />
				<include name="**/org.apache.common*" />
				<include name="**/org.apache.common*/**" />
				<include name="**/org.apache.common*/**/**" />
				<include name="**/org.eclipse.dstore*" />
				<include name="**/org.eclipse.dstore*/**" />
				<include name="**/org.eclipse.dstore*/**/**" />
			</zipfileset>
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664"
				excludes="**/org.eclipse.*.source*, **/org.eclipse.*.source*/**">
				<include name="**/org.eclipse.tm.terminal_*" />
				<include name="**/org.eclipse.tm.terminal_*/**" />
				<include name="**/org.eclipse.tm.terminal_*/**/**" />
			</zipfileset>

			<zipfileset refid="rootfiles" />
		</zip>

		<!-- build examples -->
		<zip destfile="${buildDirectory}/${buildLabel}/RSE-examples-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664">
				<include name="**/org.eclipse.*.examples*" />
				<include name="**/org.eclipse.*.examples*/**" />
				<include name="**/org.eclipse.*.examples*/**/**" />
			</zipfileset>
			<zipfileset refid="rootfiles" />
		</zip>

		<!-- build useractions -->
		<zip destfile="${buildDirectory}/${buildLabel}/RSE-useractions-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664">
				<include name="**/org.eclipse.*.useractions*" />
				<include name="**/org.eclipse.*.useractions*/**" />
				<include name="**/org.eclipse.*.useractions*/**/**" />
				<exclude name="**/org.eclipse.*.useractions.wrapper*" />
				<exclude name="**/org.eclipse.*.useractions.wrapper*/**" />
  		        <exclude name="**/org.eclipse.*.useractions.wrapper*/**/**" />
			</zipfileset>
			<zipfileset refid="rootfiles" />
		</zip>
		
		<!-- build discovery -->
		<zip destfile="${buildDirectory}/${buildLabel}/TM-discovery-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664">
				<include name="**/org.eclipse.*.discovery*" />
				<include name="**/org.eclipse.*.discovery*/**" />
				<include name="**/org.eclipse.*.discovery*/**/**" />
			</zipfileset>
			<zipfileset refid="rootfiles" />
		</zip>

		<!-- build terminal -->
		<zip destfile="${buildDirectory}/${buildLabel}/TM-terminal-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664" excludes="**/org.eclipse.*.test*, **/org.eclipse.*.test*/**, **/org.eclipse.tm.terminal.local*, **/org.eclipse.tm.terminal.local*/**">
				<include name="**/org.eclipse.tm.terminal*" />
				<include name="**/org.eclipse.tm.terminal*/**" />
				<include name="**/org.eclipse.tm.terminal*/**/**" />
			</zipfileset>
			<zipfileset refid="rootfiles" />
		</zip>

		<!-- build terminal.local -->
		<zip destfile="${buildDirectory}/${buildLabel}/TM-terminal-local-incubation-${buildAlias}.zip" update="true">
			<zipfileset src="${buildDirectory}/${buildLabel}/${allZip}" dirmode="775" filemode="664" excludes="**/org.eclipse.*.test*, **/org.eclipse.*.test*/**">
				<include name="**/org.eclipse.tm.terminal_*" />
				<include name="**/org.eclipse.tm.terminal_*/**" />
				<include name="**/org.eclipse.tm.terminal_*/**/**" />
				<include name="**/org.eclipse.tm.terminal.local*" />
				<include name="**/org.eclipse.tm.terminal.local*/**" />
				<include name="**/org.eclipse.tm.terminal.local*/**/**" />
			</zipfileset>
			<zipfileset refid="rootfiles" />
		</zip>

		
	</target>


	<!-- ===================================================================== -->
	<!-- Steps to do before running assemble. -->
	<!-- ===================================================================== -->
	<target name="preAssemble">
		<antcall target="serverruntime" />
		<antcall target="hideServerStuff" />
<!--
		<antcall target="allElements">
			<param name="target" value="gatherSources" />
		</antcall>
-->		
	</target>

	<!-- ===================================================================== -->
	<!-- Steps to do after  running assemble. -->
	<!-- ===================================================================== -->
	<target name="postAssemble">
		<antcall target="revealServerStuff" />
	</target>

	<!-- =====================================================================
	     Specialized targets hide/reveal the server stuff so it doesn't get packaged
	     in the client.          
	     ===================================================================== -->

	<target name="hideServerStuff">
		<mkdir dir="${buildDirectory}/hidden"/>
		<move todir="${buildDirectory}/hidden">
			<fileset dir="${buildDirectory}/plugins">
				<include name="**/clientserver.jar"/>
				<include name="**/dstore_core.jar"/>
				<include name="**/dstore_extra_server.jar"/>
				<include name="**/dstore_miners.jar"/>
				<include name="**/clientserversrc.zip"/>
				<include name="**/dstore_coresrc.zip"/>
				<include name="**/dstore_extra_serversrc.zip"/>
				<include name="**/dstore_minerssrc.zip"/>
			</fileset>
		</move>
	</target>

	<target name="revealServerStuff">
		<move todir="${buildDirectory}/plugins">
			<fileset dir="${buildDirectory}/hidden" includes="**" />
		</move>
		<delete dir="${buildDirectory}/hidden"/>
	</target>


	<!-- =====================================================================
	     Specialized targets to build the server runtime.           
	     ===================================================================== -->

	<target name="serverruntime">

		<property name="working" value="${buildDirectory}/${buildLabel}/rseserver"/>
		<mkdir dir="${working}" />
		<mkdir dir="${working}/jars" />

		<copy todir="${working}">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore/serverruntime" includes="**" />
		</copy>

		<copy todir="${working}/jars">
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.core" includes="dstore_core.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.dstore.extra" includes="dstore_extra_server.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services" includes="clientserver.jar" />
			<fileset dir="${buildDirectory}/plugins/org.eclipse.rse.services.dstore" includes="dstore_miners.jar" />
		</copy>

		<antcall target="rseserver-os-tar">
			<param name="os" value="unix"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os-tar">
			<param name="os" value="macosx"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os-tar">
			<param name="os" value="linux"/>
			<param name="eol" value="lf"/>
		</antcall>
		<antcall target="rseserver-os-zip">
			<param name="os" value="windows"/>
			<param name="eol" value="crlf"/>
		</antcall>

		<delete dir="${working}" />

	</target>

	<target name="rseserver-os-tar" depends="rseserver-os-collect">
		<tar destfile="${buildDirectory}/${buildLabel}/rseserver-${buildId}-${os}.tar">
			<tarfileset dir="${working}/collector" mode="755" includes="*.pl,*.sh" />
			<tarfileset dir="${working}/collector" mode="644" excludes="*.pl,*.sh" />
		</tar>
		<delete dir="${working}/collector" />
	</target>
	<target name="rseserver-os-zip" depends="rseserver-os-collect">
		<zip destfile="${buildDirectory}/${buildLabel}/rseserver-${buildId}-${os}.zip" basedir="${working}/collector" includes="*"/>
		<delete dir="${working}/collector" />
	</target>

	<target name="rseserver-os-collect">
		<mkdir dir="${working}/collector" />
		<copy todir="${working}/collector">
			<fileset dir="${working}/scripts/${os}" includes="*"/>
			<fileset dir="${working}/data" includes="*"/>
		</copy>
		<replace file="${working}/collector/build.dat">
			<replacefilter token="@build@" value="${buildId}"/>
			<replacefilter token="@version@" value="${mapVersionTag}"/>
		</replace>
		<fixcrlf srcdir="${working}/collector" eol="${eol}" eof="asis" includes="*"/>
		<copy todir="${working}/collector">
			<fileset dir="${working}/jars" includes="*"/>
			<fileset dir="${builder}/template" includes="notice.html,epl-v10.html" />
		</copy>
	</target>
				
</project>
